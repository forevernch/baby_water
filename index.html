<!doctype html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>수분 섭취 기록 (개인용)</title>
    <style>
      :root {
        --txt0: rgba(231, 234, 243, 0.92);
        --txt1: rgba(231, 234, 243, 0.70);
        --txt2: rgba(231, 234, 243, 0.60);
      }
      * { box-sizing: border-box; }
      body {
        margin: 0;
        min-height: 100vh;
        color: var(--txt0);
        font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial,
          Apple Color Emoji, Segoe UI Emoji;
        background: radial-gradient(1200px 600px at 20% 0%, #111a33 0%, #070b14 45%, #05070d 100%);
      }
      .page { padding: 24px; }
      .container { max-width: 980px; margin: 0 auto; }

      .header {
        display: flex;
        justify-content: space-between;
        align-items: baseline;
        gap: 16px;
        margin-bottom: 14px;
      }
      .title { font-size: 22px; font-weight: 800; letter-spacing: -0.2px; }
      .subtitle { font-size: 12px; color: rgba(231, 234, 243, 0.65); }

      .tabs { display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 18px; }
      .tab {
        padding: 10px 14px;
        border-radius: 999px;
        border: 1px solid rgba(255, 255, 255, 0.10);
        background: rgba(255, 255, 255, 0.04);
        color: rgba(231, 234, 243, 0.92);
        cursor: pointer;
        user-select: none;
        display: flex;
        align-items: center;
        gap: 8px;
      }
      .tab.active {
        background: rgba(56, 121, 255, 0.22);
        box-shadow: 0 0 0 1px rgba(56, 121, 255, 0.35) inset;
      }
      .tab.disabled { color: rgba(231, 234, 243, 0.35); cursor: not-allowed; }

      .card {
        border-radius: 18px;
        background: rgba(255, 255, 255, 0.04);
        border: 1px solid rgba(255, 255, 255, 0.08);
        box-shadow: 0 18px 50px rgba(0, 0, 0, 0.35);
        padding: 18px;
      }

      .section-title-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 10px;
        margin-bottom: 10px;
      }
      .section-title { font-size: 16px; font-weight: 800; letter-spacing: -0.1px; }

      .form-grid {
        display: grid;
        grid-template-columns: 1.2fr 1fr;
        gap: 14px;
        margin-top: 12px;
      }
      .label { font-size: 12px; color: rgba(231, 234, 243, 0.70); margin-bottom: 8px; }

      select, input {
        width: 100%;
        height: 44px;
        border-radius: 12px;
        border: 1px solid rgba(255, 255, 255, 0.10);
        background: rgba(6, 10, 20, 0.65);
        color: rgba(231, 234, 243, 0.95);
        padding: 0 12px;
        outline: none;
      }

      .volume-row {
        display: grid;
        grid-template-columns: 44px 1fr 44px;
        gap: 10px;
        align-items: center;
      }
      .btn-icon {
        height: 44px;
        width: 44px;
        border-radius: 12px;
        border: 1px solid rgba(255, 255, 255, 0.10);
        background: rgba(255, 255, 255, 0.06);
        color: rgba(231, 234, 243, 0.95);
        cursor: pointer;
        display: grid;
        place-items: center;
        font-size: 20px;
        font-weight: 800;
        user-select: none;
      }
      .btn-icon.disabled {
        background: rgba(255, 255, 255, 0.03);
        color: rgba(231, 234, 243, 0.30);
        cursor: not-allowed;
      }
      .volume-box {
        height: 44px;
        border-radius: 12px;
        border: 1px solid rgba(255, 255, 255, 0.10);
        background: rgba(6, 10, 20, 0.65);
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 800;
        letter-spacing: 0.2px;
      }

      .primary-btn {
        margin-top: 14px;
        height: 48px;
        width: 100%;
        border-radius: 14px;
        border: 1px solid rgba(56, 121, 255, 0.55);
        background: linear-gradient(180deg, rgba(56, 121, 255, 0.95) 0%, rgba(41, 103, 241, 0.95) 100%);
        color: white;
        font-weight: 900;
        letter-spacing: -0.1px;
        cursor: pointer;
        box-shadow: 0 16px 30px rgba(41, 103, 241, 0.35);
      }

      .divider { height: 1px; background: rgba(255, 255, 255, 0.08); margin: 18px 0; }

      .records-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 12px;
        margin-bottom: 10px;
      }
      .pill {
        padding: 6px 10px;
        border-radius: 999px;
        border: 1px solid rgba(255, 255, 255, 0.10);
        background: rgba(255, 255, 255, 0.04);
        font-size: 12px;
        color: rgba(231, 234, 243, 0.80);
        white-space: nowrap;
      }

      .list-wrap {
        border-radius: 14px;
        border: 1px solid rgba(255, 255, 255, 0.10);
        overflow: hidden;
        background: rgba(6, 10, 20, 0.55);
      }
      .list-header {
        display: grid;
        grid-template-columns: 110px 1fr 120px 90px;
        gap: 10px;
        padding: 10px 12px;
        background: rgba(255, 255, 255, 0.03);
        border-bottom: 1px solid rgba(255, 255, 255, 0.08);
        font-size: 12px;
        color: rgba(231, 234, 243, 0.70);
      }
      .row {
        display: grid;
        grid-template-columns: 110px 1fr 120px 90px;
        gap: 10px;
        padding: 10px 12px;
        border-bottom: 1px solid rgba(255, 255, 255, 0.06);
        align-items: center;
        font-size: 13px;
        color: rgba(231, 234, 243, 0.92);
      }
      .row:last-child { border-bottom: none; }
      .right { text-align: right; white-space: nowrap; }
      .del-btn {
        height: 32px;
        padding: 0 10px;
        border-radius: 10px;
        border: 1px solid rgba(255, 255, 255, 0.10);
        background: rgba(255, 255, 255, 0.05);
        color: rgba(231, 234, 243, 0.92);
        cursor: pointer;
        font-weight: 800;
        justify-self: end;
      }

      .summary-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 12px;
        margin-top: 10px;
      }
      .summary-box {
        border-radius: 14px;
        border: 1px solid rgba(255, 255, 255, 0.10);
        background: rgba(6, 10, 20, 0.55);
        padding: 12px;
      }
      .summary-label { font-size: 12px; color: rgba(231, 234, 243, 0.70); margin-bottom: 6px; }
      .summary-value { font-size: 20px; font-weight: 900; letter-spacing: -0.2px; }

      .hint { margin-top: 12px; font-size: 12px; color: rgba(231, 234, 243, 0.60); }

      /* modal */
      .modal-overlay {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.55);
        display: grid;
        place-items: center;
        padding: 16px;
        z-index: 50;
      }
      .modal {
        width: min(520px, 100%);
        border-radius: 18px;
        border: 1px solid rgba(255, 255, 255, 0.10);
        background: rgba(10, 14, 26, 0.95);
        box-shadow: 0 30px 80px rgba(0, 0, 0, 0.55);
        padding: 18px;
      }
      .modal-title { font-size: 16px; font-weight: 900; margin-bottom: 8px; }
      .modal-text { font-size: 13px; color: rgba(231, 234, 243, 0.75); line-height: 1.45; }
      .modal-btns { display: flex; justify-content: flex-end; gap: 10px; margin-top: 14px; }
      .modal-btn {
        height: 38px;
        padding: 0 12px;
        border-radius: 12px;
        border: 1px solid rgba(255, 255, 255, 0.12);
        background: rgba(255, 255, 255, 0.05);
        color: rgba(231, 234, 243, 0.92);
        cursor: pointer;
        font-weight: 800;
      }
      .modal-btn.danger {
        border: 1px solid rgba(255, 96, 96, 0.30);
        background: rgba(255, 96, 96, 0.12);
      }

      .status {
        font-size: 12px;
        color: rgba(231, 234, 243, 0.75);
        padding: 6px 10px;
        border-radius: 999px;
        border: 1px solid rgba(255, 255, 255, 0.10);
        background: rgba(255, 255, 255, 0.04);
        white-space: nowrap;
      }

      .badge-warn {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 4px 8px;
        border-radius: 999px;
        border: 1px solid rgba(255, 193, 7, 0.25);
        background: rgba(255, 193, 7, 0.10);
        color: rgba(255, 225, 140, 0.95);
        font-size: 12px;
        font-weight: 800;
        white-space: nowrap;
      }

      @media (max-width: 720px) {
        .form-grid { grid-template-columns: 1fr; }
        .list-header, .row { grid-template-columns: 92px 1fr 92px 76px; }
        .summary-grid { grid-template-columns: 1fr; }
      }
    </style>
  </head>

  <body>
    <div class="page">
      <div class="container">
        <div class="header">
          <div><div class="title">수분 섭취 기록</div></div>
          <div class="subtitle">MVP · 오프라인(로컬 저장)</div>
        </div>

        <div class="tabs" id="tabs">
          <div class="tab active" data-tab="water">💧 물/음료</div>
          <div class="tab" data-tab="foodManual">✍️ 음식 수동</div>
          <div class="tab" data-tab="foodAI">🤖 음식 AI</div>
          <div class="tab" data-tab="today">📌 오늘요약</div>
          <div class="tab disabled" title="준비중">🗓️ 월별요약</div>
        </div>

        <!-- 물/음료 탭 -->
        <div class="card" id="waterCard" data-panel="water">
          <div class="section-title-row">
            <div class="section-title">물/음료 기록</div>
          </div>

          <div class="form-grid">
            <div>
              <div class="label">음료 종류</div>
              <select id="drinkType"></select>
            </div>
            <div>
              <div class="label">용량(ml)</div>
              <div class="volume-row">
                <div class="btn-icon" id="btnMinus" aria-label="용량 감소">−</div>
                <div class="volume-box" id="volumeBox">100</div>
                <div class="btn-icon" id="btnPlus" aria-label="용량 증가">+</div>
              </div>
            </div>
          </div>

          <button class="primary-btn" id="btnAdd">기록 추가</button>
          <div class="hint">MVP에서는 음료 종류와 관계없이 입력한 ml를 그대로 합산합니다.</div>

          <div class="divider"></div>

          <div class="records-header">
            <div class="section-title">오늘 기록 — 물/음료</div>
            <div class="pill" id="waterTotalPill">총합: 0 ml</div>
          </div>

          <div class="list-wrap">
            <div class="list-header">
              <div>시간</div>
              <div>종류</div>
              <div class="right">용량</div>
              <div class="right">삭제</div>
            </div>
            <div id="waterListBody"></div>
          </div>

          <div class="hint">개인용 기록 도구(의료기기 아님). 데이터는 기기 로컬에 저장됩니다.</div>
        </div>

        <!-- 음식 수동 탭 (C: DB 없으면 0ml로 기록 + 경고 표시) -->
        <div class="card" id="foodManualCard" data-panel="foodManual" style="display:none;">
          <div class="section-title-row">
            <div class="section-title">음식 수동 기록</div>
            <div class="status" id="foodDbStatus">식품DB: 로딩중</div>
          </div>

          <div class="form-grid">
            <div>
              <div class="label">음식 이름</div>
              <input id="foodName" type="text" placeholder="예: 바나나, 사과, 김치찌개" />
            </div>
            <div>
              <div class="label">음식 중량(g)</div>
              <div class="volume-row">
                <div class="btn-icon" id="foodBtnMinus" aria-label="중량 감소">−</div>
                <div class="volume-box" id="foodWeightBox">100</div>
                <div class="btn-icon" id="foodBtnPlus" aria-label="중량 증가">+</div>
              </div>
              <input id="foodWeight" type="number" inputmode="numeric" min="0" step="10" value="100" style="display:none;" />
            </div>
          </div>

          <div class="form-grid" style="margin-top:10px;">
            <div>
              <div class="label">수분(g/100g)</div>
              <div class="volume-box" id="foodMoistureBox">-</div>
            </div>
            <div>
              <div class="label">추정 수분(ml)</div>
              <div class="volume-box" id="foodEstimatedBox">0</div>
            </div>
          </div>

          <button class="primary-btn" id="btnFoodAdd">기록 추가</button>
          <div class="hint" id="foodHint">
            DB 매칭 실패 시에도 기록은 추가되며, 수분은 0ml로 저장되고 “데이터없음” 경고가 표시됩니다.
          </div>

          <div class="divider"></div>

          <div class="records-header">
            <div class="section-title">오늘 기록 — 음식 수동</div>
            <div class="pill" id="foodManualTotalPill">총합: 0 ml</div>
          </div>

          <div class="list-wrap">
            <div class="list-header">
              <div>시간</div>
              <div>메뉴</div>
              <div class="right">수분</div>
              <div class="right">삭제</div>
            </div>
            <div id="foodManualListBody"></div>
          </div>

          <div class="hint">삭제는 전체 공통 모달을 사용합니다.</div>
        </div>

        <!-- 음식 AI 탭 (Mock UI) -->
        <div class="card" id="foodAICard" data-panel="foodAI" style="display:none;">
          <div class="section-title-row">
            <div class="section-title">음식 AI 분석</div>
            <div class="status">AI: Mock 연결</div>
          </div>

          <div class="form-grid">
            <div>
              <div class="label">음식 사진</div>
              <input id="foodAIPhoto" type="file" accept="image/*" capture="environment" />
            </div>
            <div>
              <div class="label">미리보기</div>
              <div class="volume-box" style="height:120px;" id="foodAIPreview">사진 없음</div>
            </div>
          </div>

          <button class="primary-btn" id="btnFoodAIAnalyze">분석</button>

          <div class="divider"></div>

          <div class="form-grid">
            <div>
              <div class="label">음식명(선택/수정)</div>
              <input id="foodAIName" type="text" placeholder="AI 추정 음식명" />
            </div>
            <div>
              <div class="label">중량(g)</div>
              <div class="volume-row">
                <div class="btn-icon" id="foodAIMinus">−</div>
                <div class="volume-box" id="foodAIWeightBox">150</div>
                <div class="btn-icon" id="foodAIPlus">+</div>
              </div>
            </div>
          </div>

          <div class="form-grid" style="margin-top:10px;">
            <div>
              <div class="label">추정 수분(ml)</div>
              <div class="volume-box" id="foodAIEstimated">0</div>
            </div>
            <div></div>
          </div>

          <button class="primary-btn" id="btnFoodAISave">기록 추가</button>
          <div class="hint">현재는 Mock AI입니다. 분석 시 예시 결과가 표시됩니다.</div>
        </div>

        <!-- 오늘요약 탭 -->
        <div class="card" id="todayCard" data-panel="today" style="display:none;">
          <div class="section-title-row">
            <div class="section-title">오늘요약</div>
          </div>

          <div class="summary-grid">
            <div class="summary-box">
              <div class="summary-label">물/음료 합계</div>
              <div class="summary-value" id="sumWater">0 ml</div>
            </div>
            <div class="summary-box">
              <div class="summary-label">음식수동 합계</div>
              <div class="summary-value" id="sumFoodManual">0 ml</div>
            </div>
            <div class="summary-box">
              <div class="summary-label">음식AI 합계</div>
              <div class="summary-value" id="sumFoodAI">0 ml</div>
            </div>
            <div class="summary-box">
              <div class="summary-label">오늘 총합</div>
              <div class="summary-value" id="sumAll">0 ml</div>
            </div>
          </div>

          <div class="divider"></div>

          <div class="records-header">
            <div class="section-title">오늘 기록 — 전체</div>
            <div class="pill" id="allCountPill">0건</div>
          </div>

          <div class="list-wrap">
            <div class="list-header">
              <div>시간</div>
              <div>구분</div>
              <div class="right">용량</div>
              <div class="right">삭제</div>
            </div>
            <div id="allListBody"></div>
          </div>

          <div class="hint">
            records 1개 배열에 통합 저장합니다.
            (water / foodManual / foodAI)
          </div>
        </div>
      </div>
    </div>

    <!-- Delete confirmation modal -->
    <div class="modal-overlay" id="modalOverlay" style="display:none" aria-hidden="true">
      <div class="modal" id="modal" role="dialog" aria-modal="true">
        <div class="modal-title">기록을 삭제할까요?</div>
        <div class="modal-text">선택한 항목이 즉시 삭제됩니다. 계속 진행하시겠습니까?</div>
        <div class="modal-btns">
          <button class="modal-btn" id="btnCancel">취소</button>
          <button class="modal-btn danger" id="btnConfirm">삭제</button>
        </div>
      </div>
    </div>

    <script>
      // ==========================================================
      // 안정 버전 + 음식수동(C옵션)
      //  - DB 매칭 실패해도 기록 추가 허용
      //  - volume=0, hasData=false 저장 → 리스트/오늘요약에 반영
      // ==========================================================

      const STORAGE_KEY = "hydration_html_records_v1_stable";
      const DRINK_TYPES = ["물", "우유", "주스", "탄산", "유제품", "이온음료", "기타"];
      const FOOD_DB_FILE = "./food_db.json";

      // DOM
      const elTabs = document.getElementById("tabs");
      const elWaterCard = document.getElementById("waterCard");
      const elFoodManualCard = document.getElementById("foodManualCard");
      const elTodayCard = document.getElementById("todayCard");
      const elFoodAICard = document.getElementById("foodAICard");

      // water
      const elDrinkType = document.getElementById("drinkType");
      const elVolumeBox = document.getElementById("volumeBox");
      const elMinus = document.getElementById("btnMinus");
      const elPlus = document.getElementById("btnPlus");
      const elAdd = document.getElementById("btnAdd");
      const elWaterListBody = document.getElementById("waterListBody");
      const elWaterTotal = document.getElementById("waterTotalPill");

      // food manual
      const elFoodDbStatus = document.getElementById("foodDbStatus");
      const elFoodName = document.getElementById("foodName");
      const elFoodWeight = document.getElementById("foodWeight");
      const elFoodWeightBox = document.getElementById("foodWeightBox");
      const elFoodMinus = document.getElementById("foodBtnMinus");
      const elFoodPlus = document.getElementById("foodBtnPlus");
      const elFoodMoistureBox = document.getElementById("foodMoistureBox");
      const elFoodEstimatedBox = document.getElementById("foodEstimatedBox");
      const elFoodAdd = document.getElementById("btnFoodAdd");
      const elFoodHint = document.getElementById("foodHint");
      const elFoodManualListBody = document.getElementById("foodManualListBody");
      const elFoodManualTotal = document.getElementById("foodManualTotalPill");

      // food AI
      const elFoodAIPhoto = document.getElementById("foodAIPhoto");
      const elFoodAIPreview = document.getElementById("foodAIPreview");
      const elFoodAIName = document.getElementById("foodAIName");
      const elFoodAIWeightBox = document.getElementById("foodAIWeightBox");
      const elFoodAIMinus = document.getElementById("foodAIMinus");
      const elFoodAIPlus = document.getElementById("foodAIPlus");
      const elFoodAIEstimated = document.getElementById("foodAIEstimated");
      const elFoodAIAnalyze = document.getElementById("btnFoodAIAnalyze");
      const elFoodAISave = document.getElementById("btnFoodAISave");

      // today
      const elSumWater = document.getElementById("sumWater");
      const elSumFoodManual = document.getElementById("sumFoodManual");
      const elSumFoodAI = document.getElementById("sumFoodAI");
      const elSumAll = document.getElementById("sumAll");
      const elAllCount = document.getElementById("allCountPill");
      const elAllListBody = document.getElementById("allListBody");

      // modal
      const elModalOverlay = document.getElementById("modalOverlay");
      const elModal = document.getElementById("modal");
      const elCancel = document.getElementById("btnCancel");
      const elConfirm = document.getElementById("btnConfirm");

      // State
      let activeTab = "water";
      let volume = 100;
      let records = [];
      let deleteTargetId = null;

      // food manual weight state (g)
      let foodWeightG = 100;
      let foodAIWeightG = 150;

      // Food DB
      let foodDbIndex = null; // Map(normalizedName -> moisturePer100)
      let foodDbLoaded = false;

      function pad2(n) { return String(n).padStart(2, "0"); }

      function formatTime12h(date) {
        const h24 = date.getHours();
        const m = date.getMinutes();
        const ampm = h24 >= 12 ? "pm" : "am";
        const h12 = h24 % 12 === 0 ? 12 : h24 % 12;
        return `${ampm} ${pad2(h12)}:${pad2(m)}`;
      }

      function dateKeyLocal(date) {
        const y = date.getFullYear();
        const mm = pad2(date.getMonth() + 1);
        const dd = pad2(date.getDate());
        return `${y}-${mm}-${dd}`;
      }

      function loadRecords() {
        try {
          const raw = localStorage.getItem(STORAGE_KEY);
          if (!raw) return [];
          const parsed = JSON.parse(raw);
          return Array.isArray(parsed) ? parsed : [];
        } catch {
          return [];
        }
      }

      function saveRecords(next) {
        try { localStorage.setItem(STORAGE_KEY, JSON.stringify(next)); } catch {}
      }

      function setVolume(next) {
        volume = Math.max(10, Number(next) || 10);
        elVolumeBox.textContent = String(volume);
        if (volume <= 10) elMinus.classList.add("disabled");
        else elMinus.classList.remove("disabled");
      }

      function setFoodWeight(next) {
        const n = Number(next);
        const snapped = Number.isFinite(n) ? Math.round(n / 10) * 10 : 100;
        foodWeightG = Math.max(0, snapped);
        elFoodWeightBox.textContent = String(foodWeightG);
        elFoodWeight.value = String(foodWeightG);
        if (foodWeightG <= 0) elFoodMinus.classList.add("disabled");
        else elFoodMinus.classList.remove("disabled");
      }

      function setFoodAIWeight(next) {
        const n = Number(next);
        const snapped = Number.isFinite(n) ? Math.round(n / 10) * 10 : 150;
        foodAIWeightG = Math.max(0, snapped);
        elFoodAIWeightBox.textContent = String(foodAIWeightG);
        if (foodAIWeightG <= 0) elFoodAIMinus.classList.add("disabled");
        else elFoodAIMinus.classList.remove("disabled");
      }

      function setFoodAIPreview(moisturePer100, estimatedMl, hasData) {
        elFoodAIEstimated.textContent = String(estimatedMl || 0);
      }

      function refreshFoodAIEstimation() {
        const name = String(elFoodAIName.value || "").trim();
        const weight = Number(foodAIWeightG) || 0;

        if (!name || !foodDbLoaded) {
          setFoodAIPreview(null, 0, false);
          return;
        }

        const hit = lookupMoisture(name);
        if (!hit) {
          setFoodAIPreview(null, 0, false);
          return;
        }

        setFoodAIPreview(hit.moisture, computeEstimatedMl(weight, hit.moisture), true);
      }

      function setActiveTab(next) {
        activeTab = next;
        Array.from(elTabs.querySelectorAll(".tab")).forEach((t) => {
          if (t.classList.contains("disabled")) return;
          t.classList.toggle("active", t.dataset.tab === next);
        });
        elWaterCard.style.display = next === "water" ? "block" : "none";
        elFoodManualCard.style.display = next === "foodManual" ? "block" : "none";
        elFoodAICard.style.display = next === "foodAI" ? "block" : "none";
        elTodayCard.style.display = next === "today" ? "block" : "none";
        render();
      }

      function openModal(id) {
        deleteTargetId = id;
        elModalOverlay.style.display = "grid";
        elModalOverlay.setAttribute("aria-hidden", "false");
      }

      function closeModal() {
        deleteTargetId = null;
        elModalOverlay.style.display = "none";
        elModalOverlay.setAttribute("aria-hidden", "true");
      }

      function kindLabel(r) {
        if (r.kind === "water") return `물/음료 · ${r.type}`;
        if (r.kind === "foodManual") {
          const suffix = r.hasData === false ? " (데이터없음)" : "";
          return `음식수동 · ${r.name || "-"}${suffix}`;
        }
        if (r.kind === "foodAI") return `음식AI · ${r.name || "-"}`;
        return r.kind || "-";
      }

      function renderList(targetEl, items, options) {
        targetEl.innerHTML = "";
        if (items.length === 0) {
          const empty = document.createElement("div");
          empty.className = "row";
          empty.style.gridTemplateColumns = "1fr";
          empty.textContent = "아직 기록이 없습니다.";
          targetEl.appendChild(empty);
          return;
        }

        items.forEach((r) => {
          const row = document.createElement("div");
          row.className = "row";

          const c1 = document.createElement("div");
          c1.textContent = r.timeLabel;

          const c2 = document.createElement("div");
          if (options.kindText) {
            c2.textContent = kindLabel(r);
          } else {
            if (r.kind === "foodManual" && r.hasData === false) {
              const wrap = document.createElement("div");
              wrap.style.display = "flex";
              wrap.style.gap = "10px";
              wrap.style.alignItems = "center";

              const name = document.createElement("div");
              name.textContent = r.name || "-";

              const badge = document.createElement("span");
              badge.className = "badge-warn";
              badge.textContent = "데이터없음";

              wrap.append(name, badge);
              c2.appendChild(wrap);
            } else {
              c2.textContent = r.type || r.name || "-";
            }
          }

          const c3 = document.createElement("div");
          c3.className = "right";
          c3.textContent = `${Number(r.volume) || 0} ml`;

          const c4 = document.createElement("button");
          c4.className = "del-btn";
          c4.textContent = "삭제";
          c4.addEventListener("click", () => openModal(r.id));

          row.append(c1, c2, c3, c4);
          targetEl.appendChild(row);
        });
      }

      function render() {
        const todayKey = dateKeyLocal(new Date());
        const today = records.filter((r) => r.dateKey === todayKey);

        const todayWater = today.filter((r) => r.kind === "water");
        const todayFoodManual = today.filter((r) => r.kind === "foodManual");
        const todayFoodAI = today.filter((r) => r.kind === "foodAI");

        const sumWater = todayWater.reduce((s, r) => s + (Number(r.volume) || 0), 0);
        const sumFoodManual = todayFoodManual.reduce((s, r) => s + (Number(r.volume) || 0), 0);
        const sumFoodAI = todayFoodAI.reduce((s, r) => s + (Number(r.volume) || 0), 0);
        const sumAll = sumWater + sumFoodManual + sumFoodAI;

        // water
        elWaterTotal.textContent = `총합: ${sumWater} ml`;
        renderList(elWaterListBody, todayWater, { kindText: false });

        // food manual
        elFoodManualTotal.textContent = `총합: ${sumFoodManual} ml`;
        renderList(elFoodManualListBody, todayFoodManual, { kindText: false });

        // today
        elSumWater.textContent = `${sumWater} ml`;
        elSumFoodManual.textContent = `${sumFoodManual} ml`;
        elSumFoodAI.textContent = `${sumFoodAI} ml`;
        elSumAll.textContent = `${sumAll} ml`;
        elAllCount.textContent = `${today.length}건`;

        const todaySorted = [...today].sort((a, b) => (a.ts < b.ts ? 1 : -1));
        renderList(elAllListBody, todaySorted, { kindText: true });
      }

      // ---------- Food DB ----------

      function setFoodDbStatus(text) {
        elFoodDbStatus.textContent = text;
      }

      function stripBomIfNeeded(text) {
        if (!text) return "";
        return text.charCodeAt(0) === 65279 ? text.slice(1) : text;
      }

      function normalizeFoodName(s) {
        // ⚠️ 중요: 탭/개행/캐리지리턴은 반드시 "\\t" "\\n" "\\r" 처럼 이스케이프 문자열로 비교해야 함
        // (실제 제어문자가 코드에 들어가면 "Invalid or unexpected token"로 파싱이 깨집니다.)
        const raw = (s || "").toString().trim().toLowerCase();
        let out = "";
        for (let i = 0; i < raw.length; i++) {
          const ch = raw[i];
          if (ch === " " || ch === "\t" || ch === "\n" || ch === "\r") continue;

          const code = ch.charCodeAt(0);
          const isNum = code >= 48 && code <= 57; // 0-9
          const isAZ = code >= 97 && code <= 122; // a-z
          const isHangul = code >= 44032 && code <= 55203; // 가-힣

          if (isNum || isAZ || isHangul) out += ch;
        }
        return out;
      }

      function toNumberMaybe(v) {
        if (v == null) return null;
        const s = String(v).split(",").join("").trim();
        const n = Number(s);
        return Number.isFinite(n) ? n : null;
      }

      function setFoodPreview(moisturePer100, estimatedMl, hasData) {
        elFoodMoistureBox.textContent = hasData ? String(moisturePer100) : "데이터 없음";
        elFoodEstimatedBox.textContent = String(estimatedMl || 0);
      }

      function computeEstimatedMl(weightG, moisturePer100) {
        const w = Math.max(0, Number(weightG) || 0);
        const m = Number(moisturePer100);
        if (!Number.isFinite(m)) return 0;
        return Math.round((w * m) / 100);
      }

      function lookupMoisture(name) {
        if (!foodDbIndex) return null;

        const q = normalizeFoodName(name);
        if (!q) return null;

        // 1) 완전 일치
        if (foodDbIndex.has(q)) {
          return { moisture: foodDbIndex.get(q), matched: "exact" };
        }

        // 2) 포함 관계 매칭 ("양배추" → "흰색양배추")
        let best = null;
        for (const [k, v] of foodDbIndex.entries()) {
          if (k.includes(q) || q.includes(k)) {
            const score = Math.abs(k.length - q.length);
            if (!best || score < best.score) {
              best = { moisture: v, score, matched: "partial" };
            }
          }
        }

        return best;
      }

      function refreshFoodEstimation() {
        const name = String(elFoodName.value || "").trim();
        const weight = Number(foodWeightG) || 0;

        if (!name || !foodDbLoaded) {
          setFoodPreview(null, 0, false);
          return;
        }

        const hit = lookupMoisture(name);
        if (!hit) {
          setFoodPreview(null, 0, false);
          return;
        }

        setFoodPreview(hit.moisture, computeEstimatedMl(weight, hit.moisture), true);
      }

      async function loadFoodDb() {
        try {
          setFoodDbStatus("식품DB: 로딩중");
          const res = await fetch(FOOD_DB_FILE, { cache: "no-store" });
          if (!res.ok) throw new Error("HTTP " + res.status);
          const text = stripBomIfNeeded(await res.text());
          const arr = JSON.parse(text);
          if (!Array.isArray(arr)) throw new Error("JSON is not an array");

          const idx = new Map();
          let count = 0;
          for (const obj of arr) {
            const name = obj && obj["식품명"] ? String(obj["식품명"]).trim() : "";
            const moisture = toNumberMaybe(obj ? obj["수분(g)"] : null);
            if (!name || moisture == null) continue;

            const key = normalizeFoodName(name);
            if (!key) continue;

            if (!idx.has(key)) {
              idx.set(key, moisture);
              count += 1;
            }
          }

          foodDbIndex = idx;
          foodDbLoaded = true;
          setFoodDbStatus("식품DB: " + count.toLocaleString() + "개 로드");
          refreshFoodEstimation();
        } catch (e) {
          foodDbIndex = new Map();
          foodDbLoaded = false;
          setFoodDbStatus("식품DB: 로드 실패");
          elFoodHint.textContent = "food_db.json을 찾지 못했습니다. 그래도 기록은 추가되며(0ml), 데이터없음으로 표시됩니다.";
          setFoodPreview(null, 0, false);
        }
      }

      // ---------- Self tests (console) ----------
      function assert(cond, msg) {
        if (!cond) throw new Error("[TEST FAIL] " + msg);
      }

      function runSelfTests() {
        // 공백/탭/개행 제거 테스트
        assert(normalizeFoodName("  김치\n찌개 ") === "김치찌개", "normalizeFoodName remove newline");
        assert(normalizeFoodName("김치	찌개") === "김치찌개", "normalizeFoodName remove tab");
        assert((() => { setFoodWeight(105); return foodWeightG === 110; })(), "setFoodWeight snaps to 10g");
        assert(normalizeFoodName("김치\r찌개") === "김치찌개", "normalizeFoodName remove CR");

        // 특수문자 제거 + 소문자화
        assert(normalizeFoodName("ABC-123") === "abc123", "normalizeFoodName keeps a-z0-9 only");

        // 수분 계산
        assert(computeEstimatedMl(100, 90) === 90, "computeEstimatedMl basic");
        assert(computeEstimatedMl(0, 90) === 0, "computeEstimatedMl zero weight");

        // 숫자 파싱
        assert(toNumberMaybe("1,234.5") === 1234.5, "toNumberMaybe comma");

        // 부분매칭 스모크 테스트
        const tmp = new Map();
        tmp.set(normalizeFoodName("흰색 양배추"), 91.0);
        foodDbIndex = tmp;
        assert(lookupMoisture("양배추") != null, "lookupMoisture partial contains should match");
      }

      function init() {
        try { runSelfTests(); } catch (e) { console.error(e); }

        // drink options
        DRINK_TYPES.forEach((t) => {
          const opt = document.createElement("option");
          opt.value = t;
          opt.textContent = t;
          elDrinkType.appendChild(opt);
        });
        elDrinkType.value = "물";

        // volume
        setVolume(100);
        setFoodWeight(100);
        setFoodAIWeight(150);
        refreshFoodAIEstimation();

        // load
        records = loadRecords().map((r) => {
          if (!r.kind) return { ...r, kind: "water" };
          return r;
        });

        // tabs
        elTabs.addEventListener("click", (e) => {
          const tab = e.target.closest(".tab");
          if (!tab) return;
          if (tab.classList.contains("disabled")) return;
          const next = tab.dataset.tab;
          if (!next) return;
          setActiveTab(next);
        });

        // water
        elMinus.addEventListener("click", () => {
          if (volume <= 10) return;
          setVolume(volume - 10);
        });
        elPlus.addEventListener("click", () => setVolume(volume + 10));

        elAdd.addEventListener("click", () => {
          const now = new Date();
          const item = {
            id: `${now.getTime()}_${Math.random().toString(16).slice(2)}`,
            ts: now.toISOString(),
            dateKey: dateKeyLocal(now),
            timeLabel: formatTime12h(now),
            kind: "water",
            type: elDrinkType.value,
            volume: volume,
          };
          records = [item, ...records];
          saveRecords(records);
          render();
        });

        // food manual
        elFoodName.addEventListener("input", refreshFoodEstimation);

        // 음식 중량 +/- (10g 단위)
        elFoodMinus.addEventListener("click", () => {
          if (foodWeightG <= 0) return;
          setFoodWeight(foodWeightG - 10);
          refreshFoodEstimation();
        });
        elFoodPlus.addEventListener("click", () => {
          setFoodWeight(foodWeightG + 10);
          refreshFoodEstimation();
        });

        // food AI (Mock UI + 저장 흐름)
        elFoodAIPhoto.addEventListener("change", (e) => {
          const file = e.target.files && e.target.files[0];
          if (!file) return;
          const img = document.createElement("img");
          img.style.maxHeight = "100%";
          img.style.maxWidth = "100%";
          img.style.objectFit = "contain";
          img.src = URL.createObjectURL(file);
          elFoodAIPreview.innerHTML = "";
          elFoodAIPreview.appendChild(img);
        });

        elFoodAIName.addEventListener("input", refreshFoodAIEstimation);

        elFoodAIAnalyze.addEventListener("click", () => {
          // ✅ 현재 단계: Mock AI (UI/저장 흐름 안정화)
          elFoodAIName.value = "김치찌개";
          setFoodAIWeight(300);
          refreshFoodAIEstimation();
        });

        elFoodAIMinus.addEventListener("click", () => {
          if (foodAIWeightG <= 0) return;
          setFoodAIWeight(foodAIWeightG - 10);
          refreshFoodAIEstimation();
        });
        elFoodAIPlus.addEventListener("click", () => {
          setFoodAIWeight(foodAIWeightG + 10);
          refreshFoodAIEstimation();
        });

        elFoodAISave.addEventListener("click", () => {
          const name = String(elFoodAIName.value || "").trim();
          if (!name) { elFoodAIName.focus(); return; }

          const weight = Number(foodAIWeightG) || 0;
          let hasData = false;
          let moisture = null;
          let estimated = 0;

          if (foodDbLoaded) {
            const hit = lookupMoisture(name);
            if (hit) {
              hasData = true;
              moisture = hit.moisture;
              estimated = computeEstimatedMl(weight, moisture);
            }
          }

          const now = new Date();
          const item = {
            id: `${now.getTime()}_${Math.random().toString(16).slice(2)}`,
            ts: now.toISOString(),
            dateKey: dateKeyLocal(now),
            timeLabel: formatTime12h(now),
            kind: "foodAI",
            name,
            weightG: Math.max(0, Math.round(weight)),
            moisturePer100: hasData ? moisture : null,
            hasData,
            volume: estimated,
            aiMeta: { mock: true },
          };

          records = [item, ...records];
          saveRecords(records);

          elFoodAIName.value = "";
          setFoodAIWeight(150);
          refreshFoodAIEstimation();
          render();
        });

        elFoodAdd.addEventListener("click", () => {
          const name = String(elFoodName.value || "").trim();
          const weight = Number(foodWeightG) || 0;
          if (!name) { elFoodName.focus(); return; }

          let hasData = false;
          let moisture = null;
          let estimated = 0;

          if (foodDbLoaded) {
            const hit = lookupMoisture(name);
            if (hit) {
              hasData = true;
              moisture = hit.moisture;
              estimated = computeEstimatedMl(weight, moisture);
            }
          }

          // C옵션: 매칭 실패/DB 실패여도 기록은 추가
          const now = new Date();
          const item = {
            id: `${now.getTime()}_${Math.random().toString(16).slice(2)}`,
            ts: now.toISOString(),
            dateKey: dateKeyLocal(now),
            timeLabel: formatTime12h(now),
            kind: "foodManual",
            name: name,
            weightG: Math.max(0, Math.round(weight)),
            moisturePer100: hasData ? moisture : null,
            hasData: hasData,
            volume: estimated,
          };

          records = [item, ...records];
          saveRecords(records);

          if (!hasData) {
            elFoodHint.textContent = "⚠️ DB 매칭 실패: 0ml로 저장했습니다. (데이터없음 표시)";
          } else {
            elFoodHint.textContent = "음식이름/중량을 입력하면 DB의 수분(g/100g)으로 추정합니다.";
          }

          elFoodName.value = "";
          setFoodWeight(100);
          refreshFoodEstimation();
          elFoodName.focus();
          render();
        });

        // modal
        elModalOverlay.addEventListener("mousedown", (e) => {
          if (e.target === elModalOverlay) closeModal();
        });
        elModal.addEventListener("mousedown", (e) => e.stopPropagation());
        elCancel.addEventListener("click", closeModal);
        elConfirm.addEventListener("click", () => {
          if (!deleteTargetId) return;
          records = records.filter((r) => r.id !== deleteTargetId);
          saveRecords(records);
          closeModal();
          render();
        });

        // start
        setActiveTab("water");
        render();

        // load food db
        loadFoodDb();
      }

      init();
    </script>
  </body>
</html>

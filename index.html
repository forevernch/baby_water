<!doctype html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>수분 섭취 기록 (개인용)</title>
    <style>
      :root {
        --txt0: rgba(231, 234, 243, 0.92);
        --txt1: rgba(231, 234, 243, 0.70);
        --txt2: rgba(231, 234, 243, 0.60);
      }
      * { box-sizing: border-box; }
      body {
        margin: 0;
        min-height: 100vh;
        color: var(--txt0);
        font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial,
          Apple Color Emoji, Segoe UI Emoji;
        background: radial-gradient(1200px 600px at 20% 0%, #111a33 0%, #070b14 45%, #05070d 100%);
      }
      .page { padding: 24px; }
      .container { max-width: 980px; margin: 0 auto; }

      .header {
        display: flex;
        justify-content: space-between;
        align-items: baseline;
        gap: 16px;
        margin-bottom: 14px;
      }
      .title { font-size: 22px; font-weight: 800; letter-spacing: -0.2px; }
      .subtitle { font-size: 12px; color: rgba(231, 234, 243, 0.65); }

      .tabs { display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 18px; }
      .tab {
        padding: 10px 14px;
        border-radius: 999px;
        border: 1px solid rgba(255, 255, 255, 0.10);
        background: rgba(255, 255, 255, 0.04);
        color: rgba(231, 234, 243, 0.92);
        cursor: pointer;
        user-select: none;
        display: flex;
        align-items: center;
        gap: 8px;
      }
      .tab.active {
        background: rgba(56, 121, 255, 0.22);
        box-shadow: 0 0 0 1px rgba(56, 121, 255, 0.35) inset;
      }
      .tab.disabled { color: rgba(231, 234, 243, 0.35); cursor: not-allowed; }

      .card {
        border-radius: 18px;
        background: rgba(255, 255, 255, 0.04);
        border: 1px solid rgba(255, 255, 255, 0.08);
        box-shadow: 0 18px 50px rgba(0, 0, 0, 0.35);
        padding: 18px;
      }

      .section-title-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 10px;
        margin-bottom: 10px;
      }
      .section-title { font-size: 16px; font-weight: 800; letter-spacing: -0.1px; }

      .form-grid {
        display: grid;
        grid-template-columns: 1.2fr 1fr;
        gap: 14px;
        margin-top: 12px;
      }
      .label { font-size: 12px; color: rgba(231, 234, 243, 0.70); margin-bottom: 8px; }

      select, input {
        width: 100%;
        height: 44px;
        border-radius: 12px;
        border: 1px solid rgba(255, 255, 255, 0.10);
        background: rgba(6, 10, 20, 0.65);
        color: rgba(231, 234, 243, 0.95);
        padding: 0 12px;
        outline: none;
      }

      .volume-row {
        display: grid;
        grid-template-columns: 44px 1fr 44px;
        gap: 10px;
        align-items: center;
      }
      .btn-icon {
        height: 44px;
        width: 44px;
        border-radius: 12px;
        border: 1px solid rgba(255, 255, 255, 0.10);
        background: rgba(255, 255, 255, 0.06);
        color: rgba(231, 234, 243, 0.95);
        cursor: pointer;
        display: grid;
        place-items: center;
        font-size: 20px;
        font-weight: 800;
        user-select: none;
      }
      .btn-icon.disabled {
        background: rgba(255, 255, 255, 0.03);
        color: rgba(231, 234, 243, 0.30);
        cursor: not-allowed;
      }
      .volume-box {
        height: 44px;
        border-radius: 12px;
        border: 1px solid rgba(255, 255, 255, 0.10);
        background: rgba(6, 10, 20, 0.65);
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 800;
        letter-spacing: 0.2px;
      }

      .primary-btn {
        margin-top: 14px;
        height: 48px;
        width: 100%;
        border-radius: 14px;
        border: 1px solid rgba(56, 121, 255, 0.55);
        background: linear-gradient(180deg, rgba(56, 121, 255, 0.95) 0%, rgba(41, 103, 241, 0.95)100%);
        color: white;
        font-weight: 900;
        letter-spacing: -0.1px;
        cursor: pointer;
        box-shadow: 0 16px 30px rgba(41, 103, 241, 0.35);
      }

      .divider { height: 1px; background: rgba(255, 255, 255, 0.08); margin: 18px 0; }

      .records-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 12px;
        margin-bottom: 10px;
      }
      .pill {
        padding: 6px 10px;
        border-radius: 999px;
        border: 1px solid rgba(255, 255, 255, 0.10);
        background: rgba(255, 255, 255, 0.04);
        font-size: 12px;
        color: rgba(231, 234, 243, 0.80);
        white-space: nowrap;
      }

      .list-wrap {
        border-radius: 14px;
        border: 1px solid rgba(255, 255, 255, 0.10);
        overflow: hidden;
        background: rgba(6, 10, 20, 0.55);
      }
      .list-header {
        display: grid;
        grid-template-columns: 110px 1fr 120px 90px;
        gap: 10px;
        padding: 10px 12px;
        background: rgba(255, 255, 255, 0.03);
        border-bottom: 1px solid rgba(255, 255, 255, 0.08);
        font-size: 12px;
        color: rgba(231, 234, 243, 0.70);
      }
      .row {
        display: grid;
        grid-template-columns: 110px 1fr 120px 90px;
        gap: 10px;
        padding: 10px 12px;
        border-bottom: 1px solid rgba(255, 255, 255, 0.06);
        align-items: center;
        font-size: 13px;
        color: rgba(231, 234, 243, 0.92);
      }
      .row:last-child { border-bottom: none; }
      .right { text-align: right; white-space: nowrap; }
      .del-btn {
        height: 32px;
        padding: 0 10px;
        border-radius: 10px;
        border: 1px solid rgba(255, 255, 255, 0.10);
        background: rgba(255, 255, 255, 0.05);
        color: rgba(231, 234, 243, 0.92);
        cursor: pointer;
        font-weight: 800;
        justify-self: end;
      }

      .summary-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 12px;
        margin-top: 10px;
      }
      .summary-box {
        border-radius: 14px;
        border: 1px solid rgba(255, 255, 255, 0.10);
        background: rgba(6, 10, 20, 0.55);
        padding: 12px;
      }
      .summary-label { font-size: 12px; color: rgba(231, 234, 243, 0.70); margin-bottom: 6px; }
      .summary-value { font-size: 20px; font-weight: 900; letter-spacing: -0.2px; }

      .hint { margin-top: 12px; font-size: 12px; color: rgba(231, 234, 243, 0.60); }

      /* modal */
      .modal-overlay {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.55);
        display: grid;
        place-items: center;
        padding: 16px;
        z-index: 50;
      }
      .modal {
        width: min(520px, 100%);
        border-radius: 18px;
        border: 1px solid rgba(255, 255, 255, 0.10);
        background: rgba(10, 14, 26, 0.95);
        box-shadow: 0 30px 80px rgba(0, 0, 0, 0.55);
        padding: 18px;
      }
      .modal-title { font-size: 16px; font-weight: 900; margin-bottom: 8px; }
      .modal-text { font-size: 13px; color: rgba(231, 234, 243, 0.75); line-height: 1.45; }
      .modal-btns { display: flex; justify-content: flex-end; gap: 10px; margin-top: 14px; }
      .modal-btn {
        height: 38px;
        padding: 0 12px;
        border-radius: 12px;
        border: 1px solid rgba(255, 255, 255, 0.12);
        background: rgba(255, 255, 255, 0.05);
        color: rgba(231, 234, 243, 0.92);
        cursor: pointer;
        font-weight: 800;
      }
      .modal-btn.danger {
        border: 1px solid rgba(255, 96, 96, 0.30);
        background: rgba(255, 96, 96, 0.12);
      }

      .status {
        font-size: 12px;
        color: rgba(231, 234, 243, 0.75);
        padding: 6px 10px;
        border-radius: 999px;
        border: 1px solid rgba(255, 255, 255, 0.10);
        background: rgba(255, 255, 255, 0.04);
        white-space: nowrap;
      }

      .badge-warn {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 4px 8px;
        border-radius: 999px;
        border: 1px solid rgba(255, 193, 7, 0.25);
        background: rgba(255, 193, 7, 0.10);
        color: rgba(255, 225, 140, 0.95);
        font-size: 12px;
        font-weight: 800;
        white-space: nowrap;
      }

      @media (max-width: 720px) {
        .form-grid { grid-template-columns: 1fr; }
        .list-header, .row { grid-template-columns: 92px 1fr 92px 76px; }
        .summary-grid { grid-template-columns: 1fr; }
      }
    </style>
  </head>

  <body>
    <div class="page">
      <div class="container">
        <div class="header">
          <div><div class="title">수분 섭취 기록</div></div>
          <div class="subtitle">MVP · 오프라인(로컬 저장)</div>
        </div>

        <div class="tabs" id="tabs">
          <div class="tab active" data-tab="water">💧 물/음료</div>
          <div class="tab" data-tab="foodManual">✍️ 음식 수동</div>
          <div class="tab" data-tab="foodAI">🤖 음식 AI</div>
          <div class="tab" data-tab="today">📌 오늘요약</div>
          <div class="tab disabled" title="준비중">🗓️ 월별요약</div>
        </div>

        <div class="card" id="waterCard" data-panel="water">
          <div class="section-title-row">
            <div class="section-title">물/음료 기록</div>
          </div>

          <div class="form-grid">
            <div>
              <div class="label">음료 종류</div>
              <select id="drinkType"></select>
            </div>
            <div>
              <div class="label">용량(ml)</div>
              <div class="volume-row">
                <div class="btn-icon" id="btnMinus" aria-label="용량 감소">−</div>
                <div class="volume-box" id="volumeBox">100</div>
                <div class="btn-icon" id="btnPlus" aria-label="용량 증가">+</div>
              </div>
            </div>
          </div>

          <button class="primary-btn" id="btnAdd">기록 추가</button>
          <div class="hint">음료 종류와 관계없이 입력한 ml를 그대로 합산합니다.</div>

          <div class="divider"></div>

          <div class="records-header">
            <div class="section-title">오늘 기록 — 물/음료</div>
            <div class="pill" id="waterTotalPill">총합: 0 ml</div>
          </div>

          <div class="list-wrap">
            <div class="list-header">
              <div>시간</div>
              <div>종류</div>
              <div class="right">용량</div>
              <div class="right">삭제</div>
            </div>
            <div id="waterListBody"></div>
          </div>
        </div>

        <div class="card" id="foodManualCard" data-panel="foodManual" style="display:none;">
          <div class="section-title-row">
            <div class="section-title">음식 수동 기록</div>
            <div class="status" id="foodDbStatus">식품DB: 로딩중</div>
          </div>

          <div class="form-grid">
            <div>
              <div class="label">음식 이름</div>
              <input id="foodName" type="text" placeholder="예: 바나나, 사과, 김치찌개" />
            </div>
            <div>
              <div class="label">음식 중량(g)</div>
              <div class="volume-row">
                <div class="btn-icon" id="foodBtnMinus" aria-label="중량 감소">−</div>
                <div class="volume-box" id="foodWeightBox">100</div>
                <div class="btn-icon" id="foodBtnPlus" aria-label="중량 증가">+</div>
              </div>
              <input id="foodWeight" type="number" inputmode="numeric" min="0" step="10" value="100" style="display:none;" />
            </div>
          </div>

          <div class="form-grid" style="margin-top:10px;">
            <div>
              <div class="label">수분(g/100g)</div>
              <div class="volume-box" id="foodMoistureBox">-</div>
            </div>
            <div>
              <div class="label">추정 수분(ml)</div>
              <div class="volume-box" id="foodEstimatedBox">0</div>
            </div>
          </div>

          <button class="primary-btn" id="btnFoodAdd">기록 추가</button>
          <div class="hint" id="foodHint">
            DB 매칭 실패 시에도 기록은 추가되며, 수분은 0ml로 저장되고 “데이터없음” 경고가 표시됩니다.
          </div>

          <div class="divider"></div>

          <div class="records-header">
            <div class="section-title">오늘 기록 — 음식 수동</div>
            <div class="pill" id="foodManualTotalPill">총합: 0 ml</div>
          </div>

          <div class="list-wrap">
            <div class="list-header">
              <div>시간</div>
              <div>메뉴</div>
              <div class="right">수분</div>
              <div class="right">삭제</div>
            </div>
            <div id="foodManualListBody"></div>
          </div>
        </div>

        <div class="card" id="foodAICard" data-panel="foodAI" style="display:none;">
          <div class="section-title-row">
            <div class="section-title">음식 AI 분석</div>
            <div class="status">AI: Mock 연결</div>
          </div>

          <div class="form-grid">
            <div>
              <div class="label">음식 사진</div>
              <input id="foodAIPhoto" type="file" accept="image/*" capture="environment" />
            </div>
            <div>
              <div class="label">미리보기</div>
              <div class="volume-box" style="height:120px;" id="foodAIPreview">사진 없음</div>
            </div>
          </div>

          <button class="primary-btn" id="btnFoodAIAnalyze">분석</button>

          <div class="divider"></div>

          <div class="form-grid">
            <div>
              <div class="label">음식명(선택/수정)</div>
              <input id="foodAIName" type="text" placeholder="AI 추정 음식명" />
            </div>
            <div>
              <div class="label">중량(g)</div>
              <div class="volume-row">
                <div class="btn-icon" id="foodAIMinus">−</div>
                <div class="volume-box" id="foodAIWeightBox">150</div>
                <div class="btn-icon" id="foodAIPlus">+</div>
              </div>
            </div>
          </div>

          <div class="form-grid" style="margin-top:10px;">
            <div>
              <div class="label">수분(g/100g)</div>
              <div class="volume-box" id="foodAIMoistureBox">-</div>
            </div>
            <div>
              <div class="label">추정 수분(ml)</div>
              <div class="volume-box" id="foodAIEstimated">0</div>
            </div>
          </div>

          <button class="primary-btn" id="btnFoodAISave">기록 추가</button>
          <div class="divider"></div>

          <div class="records-header">
            <div class="section-title">오늘 기록 — 음식 AI</div>
            <div class="pill" id="foodAITotalPill">총합: 0 ml</div>
          </div>

          <div class="list-wrap">
            <div class="list-header">
              <div>시간</div>
              <div>메뉴</div>
              <div class="right">수분</div>
              <div class="right">삭제</div>
            </div>
            <div id="foodAIListBody"></div>
          </div>
        </div>

        <div class="card" id="todayCard" data-panel="today" style="display:none;">
          <div class="section-title-row">
            <div class="section-title">오늘요약</div>
          </div>

          <div class="summary-grid">
            <div class="summary-box">
              <div class="summary-label">물/음료</div>
              <div class="summary-value" id="sumWater">0 ml</div>
            </div>
            <div class="summary-box">
              <div class="summary-label">음식수동</div>
              <div class="summary-value" id="sumFoodManual">0 ml</div>
            </div>
            <div class="summary-box">
              <div class="summary-label">음식AI</div>
              <div class="summary-value" id="sumFoodAI">0 ml</div>
            </div>
            <div class="summary-box">
              <div class="summary-label">오늘합계</div>
              <div class="summary-value" id="sumAll">0 ml</div>
            </div>
          </div>

          <div class="divider"></div>

          <div class="records-header">
            <div class="section-title">오늘 기록 — 전체</div>
            <div class="pill" id="allCountPill">0건</div>
          </div>

          <div class="list-wrap">
            <div class="list-header">
              <div>시간</div>
              <div>구분</div>
              <div class="right">용량</div>
              <div class="right">삭제</div>
            </div>
            <div id="allListBody"></div>
          </div>
        </div>
      </div>
    </div>

    <div class="modal-overlay" id="modalOverlay" style="display:none" aria-hidden="true">
      <div class="modal" id="modal" role="dialog" aria-modal="true">
        <div class="modal-title">기록을 삭제할까요?</div>
        <div class="modal-text">선택한 항목이 즉시 삭제됩니다. 계속 진행하시겠습니까?</div>
        <div class="modal-btns">
          <button class="modal-btn" id="btnCancel">취소</button>
          <button class="modal-btn danger" id="btnConfirm">삭제</button>
        </div>
      </div>
    </div>

    <div class="modal-overlay" id="foodPickOverlay" style="display:none" aria-hidden="true">
      <div class="modal" id="foodPickModal" role="dialog" aria-modal="true">
        <div class="modal-title">식품 DB 중복 항목 선택</div>
        <div class="modal-text" id="foodPickText">같은 이름으로 여러 DB 항목이 있습니다. 사용할 항목을 선택하세요.</div>
        <div style="margin-top:12px;">
          <div class="label">후보 목록</div>
          <select id="foodPickSelect" style="height:44px;"></select>
          <div class="hint" id="foodPickHint" style="margin-top:8px;">(표시: 식품명 · 수분(g/100g))</div>
        </div>
        <div class="modal-btns">
          <button class="modal-btn" id="foodPickCancel">취소</button>
          <button class="modal-btn danger" id="foodPickConfirm">선택</button>
        </div>
      </div>
    </div>

    <script>
      const STORAGE_KEY = "hydration_html_records_v1_stable";
      const DRINK_TYPES = ["물", "우유", "주스", "탄산", "유제품", "이온음료", "기타"];
      const FOOD_DB_FILE = "./food_db.json";

      // DOM
      const elTabs = document.getElementById("tabs");
      const elWaterCard = document.getElementById("waterCard");
      const elFoodManualCard = document.getElementById("foodManualCard");
      const elTodayCard = document.getElementById("todayCard");
      const elFoodAICard = document.getElementById("foodAICard");

      const elDrinkType = document.getElementById("drinkType");
      const elVolumeBox = document.getElementById("volumeBox");
      const elMinus = document.getElementById("btnMinus");
      const elPlus = document.getElementById("btnPlus");
      const elAdd = document.getElementById("btnAdd");
      const elWaterListBody = document.getElementById("waterListBody");
      const elWaterTotal = document.getElementById("waterTotalPill");

      const elFoodDbStatus = document.getElementById("foodDbStatus");
      const elFoodName = document.getElementById("foodName");
      const elFoodWeight = document.getElementById("foodWeight");
      const elFoodWeightBox = document.getElementById("foodWeightBox");
      const elFoodMinus = document.getElementById("foodBtnMinus");
      const elFoodPlus = document.getElementById("foodBtnPlus");
      const elFoodMoistureBox = document.getElementById("foodMoistureBox");
      const elFoodEstimatedBox = document.getElementById("foodEstimatedBox");
      const elFoodAdd = document.getElementById("btnFoodAdd");
      const elFoodHint = document.getElementById("foodHint");
      const elFoodManualListBody = document.getElementById("foodManualListBody");
      const elFoodManualTotal = document.getElementById("foodManualTotalPill");

      const elFoodAIPhoto = document.getElementById("foodAIPhoto");
      const elFoodAIPreview = document.getElementById("foodAIPreview");
      const elFoodAIName = document.getElementById("foodAIName");
      const elFoodAIWeightBox = document.getElementById("foodAIWeightBox");
      const elFoodAIMinus = document.getElementById("foodAIMinus");
      const elFoodAIPlus = document.getElementById("foodAIPlus");
      const elFoodAIEstimated = document.getElementById("foodAIEstimated");
      const elFoodAIAnalyze = document.getElementById("btnFoodAIAnalyze");
      const elFoodAISave = document.getElementById("btnFoodAISave");
      const elFoodAIMoistureBox = document.getElementById("foodAIMoistureBox");
      const elFoodAIListBody = document.getElementById("foodAIListBody");
      const elFoodAITotal = document.getElementById("foodAITotalPill");

      const elSumWater = document.getElementById("sumWater");
      const elSumFoodManual = document.getElementById("sumFoodManual");
      const elSumFoodAI = document.getElementById("sumFoodAI");
      const elSumAll = document.getElementById("sumAll");
      const elAllCount = document.getElementById("allCountPill");
      const elAllListBody = document.getElementById("allListBody");

      const elModalOverlay = document.getElementById("modalOverlay");
      const elModal = document.getElementById("modal");
      const elCancel = document.getElementById("btnCancel");
      const elConfirm = document.getElementById("btnConfirm");

      const elFoodPickOverlay = document.getElementById("foodPickOverlay");
      const elFoodPickModal = document.getElementById("foodPickModal");
      const elFoodPickText = document.getElementById("foodPickText");
      const elFoodPickSelect = document.getElementById("foodPickSelect");
      const elFoodPickCancel = document.getElementById("foodPickCancel");
      const elFoodPickConfirm = document.getElementById("foodPickConfirm");

      // State
      let activeTab = "water";
      let volume = 100;
      let records = [];
      let deleteTargetId = null;
      let foodWeightG = 100;
      let foodAIWeightG = 150;
      let foodDbIndex = null;
      let foodDbLoaded = false;
      let pendingFoodPick = null;
      const foodChoiceCache = new Map();

      function pad2(n) { return String(n).padStart(2, "0"); }
      function formatTime12h(date) {
        const h24 = date.getHours();
        const m = date.getMinutes();
        const ampm = h24 >= 12 ? "pm" : "am";
        const h12 = h24 % 12 === 0 ? 12 : h24 % 12;
        return `${ampm} ${pad2(h12)}:${pad2(m)}`;
      }
      function dateKeyLocal(date) {
        return `${date.getFullYear()}-${pad2(date.getMonth() + 1)}-${pad2(date.getDate())}`;
      }

      function loadRecords() {
        try {
          const raw = localStorage.getItem(STORAGE_KEY);
          return raw ? JSON.parse(raw) : [];
        } catch { return []; }
      }
      function saveRecords(next) {
        try { localStorage.setItem(STORAGE_KEY, JSON.stringify(next)); } catch {}
      }

      function setVolume(next) {
        volume = Math.max(10, Number(next) || 10);
        elVolumeBox.textContent = String(volume);
        elMinus.classList.toggle("disabled", volume <= 10);
      }
      function setFoodWeight(next) {
        foodWeightG = Math.max(0, Math.round(next / 10) * 10);
        elFoodWeightBox.textContent = String(foodWeightG);
        elFoodWeight.value = String(foodWeightG);
        elFoodMinus.classList.toggle("disabled", foodWeightG <= 0);
      }
      function setFoodAIWeight(next) {
        foodAIWeightG = Math.max(0, Math.round(next / 10) * 10);
        elFoodAIWeightBox.textContent = String(foodAIWeightG);
        elFoodAIMinus.classList.toggle("disabled", foodAIWeightG <= 0);
      }

      function normalizeFoodName(s) {
        return (s || "").toString().replace(/[\s\t\n\r]/g, "").toLowerCase().replace(/[^a-z0-9가-힣]/g, "");
      }
      function toNumberMaybe(v) {
        if (v == null) return null;
        const n = Number(String(v).replace(/,/g, "").trim());
        return Number.isFinite(n) ? n : null;
      }
      function computeEstimatedMl(weightG, moisturePer100) {
        return Math.round((Math.max(0, weightG) * (Number(moisturePer100) || 0)) / 100);
      }

      function lookupMoisture(name) {
        if (!foodDbIndex) return null;
        const q = normalizeFoodName(name);
        if (!q) return null;
        if (foodChoiceCache.has(q)) {
          const c = foodChoiceCache.get(q);
          return { kind: "single", moisture: c.moisture, label: c.label };
        }
        if (foodDbIndex.has(q)) {
          const list = foodDbIndex.get(q);
          return list.length === 1 ? { kind: "single", ...list[0] } : { kind: "multi", candidates: list, nameKey: q };
        }
        let bestKey = null, minDiff = Infinity;
        for (const k of foodDbIndex.keys()) {
          if (k.includes(q) || q.includes(k)) {
            const diff = Math.abs(k.length - q.length);
            if (diff < minDiff) { minDiff = diff; bestKey = k; }
          }
        }
        if (bestKey) {
          const list = foodDbIndex.get(bestKey);
          return list.length === 1 ? { kind: "single", ...list[0] } : { kind: "multi", candidates: list, nameKey: bestKey };
        }
        return null;
      }

      function setFoodPreview(moisture, estimated, hasData) {
        elFoodMoistureBox.textContent = hasData ? String(moisture) : "데이터 없음";
        elFoodEstimatedBox.textContent = String(estimated || 0);
      }
      function setFoodAIPreview(moisture, estimated, hasData) {
        elFoodAIMoistureBox.textContent = hasData ? String(moisture) : "데이터 없음";
        elFoodAIEstimated.textContent = String(estimated || 0);
      }

      function refreshFoodEstimation() {
        const name = String(elFoodName.value || "").trim();
        const weight = foodWeightG;
        if (!name || !foodDbLoaded) { setFoodPreview(null, 0, false); return; }
        const hit = lookupMoisture(name);
        let hasData = false, moisture = null, estimated = 0;
        if (hit) {
          if (hit.kind === "multi") {
            openFoodPickModal({ ctx: "manual", nameRaw: name, nameKey: hit.nameKey, weightG: weight, candidates: hit.candidates, 
              onPicked: (entry) => {
                foodChoiceCache.set(hit.nameKey, entry);
                setFoodPreview(entry.moisture, computeEstimatedMl(weight, entry.moisture), true);
              }
            });
            return;
          }
          hasData = true; moisture = hit.moisture; estimated = computeEstimatedMl(weight, moisture);
        }
        setFoodPreview(moisture, estimated, hasData);
      }

      function refreshFoodAIEstimation() {
        const name = String(elFoodAIName.value || "").trim();
        const weight = foodAIWeightG;
        if (!name || !foodDbLoaded) { setFoodAIPreview(null, 0, false); return; }
        const hit = lookupMoisture(name);
        let hasData = false, moisture = null, estimated = 0;
        if (hit) {
          if (hit.kind === "multi") {
            openFoodPickModal({ ctx: "ai", nameRaw: name, nameKey: hit.nameKey, weightG: weight, candidates: hit.candidates, 
              onPicked: (entry) => {
                foodChoiceCache.set(hit.nameKey, entry);
                setFoodAIPreview(entry.moisture, computeEstimatedMl(weight, entry.moisture), true);
              }
            });
            return;
          }
          hasData = true; moisture = hit.moisture; estimated = computeEstimatedMl(weight, moisture);
        }
        setFoodAIPreview(moisture, estimated, hasData);
      }

      async function loadFoodDb() {
        try {
          setFoodDbStatus("식품DB: 로딩중");
          const res = await fetch(FOOD_DB_FILE, { cache: "no-store" });
          if (!res.ok) throw new Error();
          const arr = JSON.parse(await res.text());
          const idx = new Map();
          let count = 0;
          for (const obj of arr) {
            const name = (obj["식품명"] || "").trim(), moisture = toNumberMaybe(obj["수분(g)"]);
            if (!name || moisture == null) continue;
            const key = normalizeFoodName(name);
            if (!idx.has(key)) idx.set(key, []);
            idx.get(key).push({ label: name, moisture });
            count++;
          }
          foodDbIndex = idx; foodDbLoaded = true;
          setFoodDbStatus(`식품DB: ${count.toLocaleString()}행 로드`);
          refreshFoodEstimation(); refreshFoodAIEstimation();
        } catch {
          setFoodDbStatus("식품DB: 로드 실패");
        }
      }

      function openFoodPickModal(p) {
        pendingFoodPick = p;
        elFoodPickText.textContent = `"${p.nameRaw}" 중복 항목 선택`;
        elFoodPickSelect.innerHTML = p.candidates.map((c, i) => `<option value="${i}">${c.label} · ${c.moisture}</option>`).join("");
        elFoodPickOverlay.style.display = "grid";
      }

      function renderList(target, items, options) {
        target.innerHTML = items.length ? "" : '<div class="row" style="grid-template-columns:1fr">기록이 없습니다.</div>';
        items.forEach(r => {
          const row = document.createElement("div");
          row.className = "row";
          const label = options.kindText ? (r.kind === "water" ? `물 · ${r.type}` : `${r.kind === "foodAI" ? "AI" : "수동"} · ${r.name}`) : (r.type || r.name);
          row.innerHTML = `<div>${r.timeLabel}</div><div>${label}${r.hasData === false ? ' <span class="badge-warn">데이터없음</span>' : ""}</div>
            <div class="right">${r.volume} ml</div><div class="right"><button class="del-btn" onclick="openModal('${r.id}')">삭제</button></div>`;
          target.appendChild(row);
        });
      }

      function render() {
        const todayKey = dateKeyLocal(new Date());
        const today = records.filter(r => r.dateKey === todayKey);
        const w = today.filter(r => r.kind === "water"), fm = today.filter(r => r.kind === "foodManual"), fa = today.filter(r => r.kind === "foodAI");
        const sw = w.reduce((s, r) => s + r.volume, 0), sfm = fm.reduce((s, r) => s + r.volume, 0), sfa = fa.reduce((s, r) => s + r.volume, 0);
        
        elWaterTotal.textContent = `총합: ${sw} ml`; renderList(elWaterListBody, w, {kindText: false});
        elFoodManualTotal.textContent = `총합: ${sfm} ml`; renderList(elManualListBody, fm, {kindText: false});
        elFoodAITotal.textContent = `총합: ${sfa} ml`; renderList(elFoodAIListBody, fa, {kindText: false});
        
        elSumWater.textContent = `${sw} ml`; elSumFoodManual.textContent = `${sfm} ml`; elSumFoodAI.textContent = `${sfa} ml`;
        elSumAll.textContent = `${sw + sfm + sfa} ml`; elAllCount.textContent = `${today.length}건`;
        renderList(elAllListBody, [...today].sort((a, b) => b.ts.localeCompare(a.ts)), {kindText: true});
      }

      function openModal(id) { deleteTargetId = id; elModalOverlay.style.display = "grid"; }
      function closeModal() { elModalOverlay.style.display = "none"; }
      function setActiveTab(t) {
        activeTab = t;
        document.querySelectorAll(".tab").forEach(el => el.classList.toggle("active", el.dataset.tab === t));
        [elWaterCard, elFoodManualCard, elFoodAICard, elTodayCard].forEach(c => c.style.display = c.dataset.panel === t ? "block" : "none");
        render();
      }

      function init() {
        DRINK_TYPES.forEach(t => { const o = document.createElement("option"); o.value = t; o.textContent = t; elDrinkType.appendChild(o); });
        records = loadRecords();
        elTabs.addEventListener("click", e => { const t = e.target.closest(".tab"); if (t && !t.classList.contains("disabled")) setActiveTab(t.dataset.tab); });
        elMinus.addEventListener("click", () => setVolume(volume - 10));
        elPlus.addEventListener("click", () => setVolume(volume + 10));
        elAdd.addEventListener("click", () => {
          const now = new Date();
          records.unshift({ id: Date.now().toString(), ts: now.toISOString(), dateKey: dateKeyLocal(now), timeLabel: formatTime12h(now), kind: "water", type: elDrinkType.value, volume });
          saveRecords(records); render();
        });
        elFoodName.addEventListener("input", refreshFoodEstimation);
        elFoodMinus.addEventListener("click", () => { setFoodWeight(foodWeightG - 10); refreshFoodEstimation(); });
        elFoodPlus.addEventListener("click", () => { setFoodWeight(foodWeightG + 10); refreshFoodEstimation(); });
        elFoodAdd.addEventListener("click", () => {
          const name = elFoodName.value.trim(); if (!name) return;
          const hit = lookupMoisture(name);
          const moisture = hit && hit.kind === "single" ? hit.moisture : null;
          const now = new Date();
          records.unshift({ id: Date.now().toString(), ts: now.toISOString(), dateKey: dateKeyLocal(now), timeLabel: formatTime12h(now), kind: "foodManual", name, weightG: foodWeightG, volume: computeEstimatedMl(foodWeightG, moisture), hasData: !!moisture });
          saveRecords(records); elFoodName.value = ""; setFoodWeight(100); refreshFoodEstimation(); render();
        });
        elFoodAIAnalyze.addEventListener("click", () => { elFoodAIName.value = "김치찌개"; setFoodAIWeight(300); refreshFoodAIEstimation(); });
        elFoodAISave.addEventListener("click", () => {
          const name = elFoodAIName.value.trim(); if (!name) return;
          const hit = lookupMoisture(name);
          const moisture = hit && hit.kind === "single" ? hit.moisture : null;
          const now = new Date();
          records.unshift({ id: Date.now().toString(), ts: now.toISOString(), dateKey: dateKeyLocal(now), timeLabel: formatTime12h(now), kind: "foodAI", name, weightG: foodAIWeightG, volume: computeEstimatedMl(foodAIWeightG, moisture), hasData: !!moisture });
          saveRecords(records); elFoodAIName.value = ""; setFoodAIWeight(150); refreshFoodAIEstimation(); render();
        });
        elConfirm.addEventListener("click", () => { records = records.filter(r => r.id !== deleteTargetId); saveRecords(records); closeModal(); render(); });
        elCancel.addEventListener("click", closeModal);
        elFoodPickConfirm.addEventListener("click", () => {
          const entry = pendingFoodPick.candidates[elFoodPickSelect.value];
          foodChoiceCache.set(pendingFoodPick.nameKey, entry);
          pendingFoodPick.onPicked(entry);
          elFoodPickOverlay.style.display = "none";
        });
        elFoodPickCancel.addEventListener("click", () => elFoodPickOverlay.style.display = "none");
        setActiveTab("water"); loadFoodDb();
      }
      init();
    </script>
  </body>
</html>